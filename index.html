<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bac Tunisie Hub - Complet</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 750: '#1e293b' } // Custom dark color
                    }
                }
            }
        }
    </script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- 1. CONFIGURATION FIREBASE (À REMPLACER) ---
        const firebaseConfig = {
  apiKey: "AIzaSyA0EvT1wX89zK6RYbyoWwoxfQjVsi_iro4",
  authDomain: "bac-tunisie-hub.firebaseapp.com",
  projectId: "bac-tunisie-hub",
  storageBucket: "bac-tunisie-hub.firebasestorage.app",
  messagingSenderId: "197783232548",
  appId: "1:197783232548:web:357418ad0cb99a741fb8b1",
  measurementId: "G-HC44GFL8MW"
};

        // --- Initialisation Firebase ---
        let app, db, storage, auth;
        let configError = false;
        
        try {
            if (firebaseConfig.apiKey === "VOTRE_API_KEY_ICI") {
                configError = true;
            } else {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                storage = getStorage(app);
                auth = getAuth(app);
            }
        } catch (e) {
            console.error("Firebase Error", e);
            configError = true;
        }

        const { useState, useEffect, useRef } = React;

        // --- 2. JEU D'ICÔNES SVG (Pas d'install nécessaire) ---
        const Icons = {
            GraduationCap: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 0 6-3 6-7 0 5 6 7 6 7v-5M12 22v-7"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            Loader: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Video: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
        };

        // --- 3. DONNÉES COMPLÈTES (Toutes sections) ---
        const BAC_DATA = {
            math: { label: "Maths", color: "from-blue-600 to-indigo-600", subjects: [ {id:"math",name:"Maths",coeff:4}, {id:"phy",name:"Physique",coeff:4}, {id:"fr",name:"Français",coeff:1}, {id:"eng",name:"Anglais",coeff:1}, {id:"philo",name:"Philo",coeff:1}, {id:"arabe",name:"Arabe",coeff:1}, {id:"info",name:"Info",coeff:1}, {id:"svt",name:"SVT",coeff:1}, {id:"sport",name:"Sport",coeff:1}, {id:"opt",name:"Option",coeff:1,isOption:true} ], scoreFormula: (mg, g) => 4*mg + 2*(g.math||0) + 1.5*(g.phy||0) + 0.5*(g.fr||0) + 0.5*(g.eng||0) },
            sc_exp: { label: "Sciences", color: "from-emerald-600 to-teal-600", subjects: [ {id:"svt",name:"SVT",coeff:4}, {id:"phy",name:"Physique",coeff:4}, {id:"math",name:"Maths",coeff:3}, {id:"fr",name:"Français",coeff:1}, {id:"eng",name:"Anglais",coeff:1}, {id:"philo",name:"Philo",coeff:1}, {id:"arabe",name:"Arabe",coeff:1}, {id:"info",name:"Info",coeff:1}, {id:"sport",name:"Sport",coeff:1}, {id:"opt",name:"Option",coeff:1,isOption:true} ], scoreFormula: (mg, g) => 4*mg + 1.5*(g.svt||0) + 1.5*(g.phy||0) + 1*(g.math||0) + 0.5*(g.fr||0) + 0.5*(g.eng||0) },
            tech: { label: "Technique", color: "from-amber-600 to-orange-600", subjects: [ {id:"tech",name:"Technique",coeff:4}, {id:"phy",name:"Physique",coeff:4}, {id:"math",name:"Maths",coeff:3}, {id:"fr",name:"Français",coeff:1}, {id:"eng",name:"Anglais",coeff:1}, {id:"philo",name:"Philo",coeff:1}, {id:"arabe",name:"Arabe",coeff:1}, {id:"info",name:"Info",coeff:1}, {id:"sport",name:"Sport",coeff:1}, {id:"opt",name:"Option",coeff:1,isOption:true} ], scoreFormula: (mg, g) => 4*mg + 1.5*(g.tech||0) + 1.5*(g.phy||0) + 1*(g.math||0) + 0.5*(g.fr||0) + 0.5*(g.eng||0) },
            eco: { label: "Eco-Gestion", color: "from-cyan-600 to-blue-600", subjects: [ {id:"eco",name:"Eco",coeff:3}, {id:"gestion",name:"Gestion",coeff:3}, {id:"math",name:"Maths",coeff:2}, {id:"hg",name:"Hist-Géo",coeff:2}, {id:"fr",name:"Français",coeff:1}, {id:"eng",name:"Anglais",coeff:1}, {id:"arabe",name:"Arabe",coeff:1}, {id:"philo",name:"Philo",coeff:1}, {id:"info",name:"Info",coeff:1}, {id:"sport",name:"Sport",coeff:1}, {id:"opt",name:"Option",coeff:1,isOption:true} ], scoreFormula: (mg, g) => 4*mg + 1.5*(g.eco||0) + 1.5*(g.gestion||0) + 0.5*(g.math||0) + 0.5*(g.hg||0) + 0.5*(g.fr||0) + 0.5*(g.eng||0) },
            info: { label: "Info", color: "from-violet-600 to-purple-600", subjects: [ {id:"algo",name:"Algo",coeff:4}, {id:"base",name:"BDD",coeff:3}, {id:"math",name:"Maths",coeff:3}, {id:"phy",name:"Physique",coeff:2}, {id:"fr",name:"Français",coeff:1}, {id:"eng",name:"Anglais",coeff:1}, {id:"philo",name:"Philo",coeff:1}, {id:"arabe",name:"Arabe",coeff:1}, {id:"sport",name:"Sport",coeff:1}, {id:"opt",name:"Option",coeff:1,isOption:true} ], scoreFormula: (mg, g) => 4*mg + 1.5*(g.algo||0) + 1.5*(g.math||0) + 0.5*(g.phy||0) + 0.5*(g.fr||0) + 0.5*(g.eng||0) },
            lettres: { label: "Lettres", color: "from-pink-600 to-rose-600", subjects: [ {id:"arabe",name:"Arabe",coeff:4}, {id:"philo",name:"Philo",coeff:4}, {id:"hg",name:"Hist-Géo",coeff:3}, {id:"fr",name:"Français",coeff:2}, {id:"eng",name:"Anglais",coeff:2}, {id:"info",name:"Info",coeff:1}, {id:"math",name:"Maths",coeff:1}, {id:"sport",name:"Sport",coeff:1}, {id:"opt",name:"Option",coeff:1,isOption:true} ], scoreFormula: (mg, g) => 4*mg + 1.5*(g.arabe||0) + 1.5*(g.philo||0) + 1*(g.hg||0) + 0.5*(g.fr||0) + 0.5*(g.eng||0) }
        };

        const IMPORTANT_DATES = [
            { event: "Bac Sport", date: "2025-04-15" },
            { event: "Bac Blanc", date: "2025-05-10" },
            { event: "Bac Principal", date: "2025-06-04" },
            { event: "Résultats", date: "2025-06-25" }
        ];

        // --- COMPOSANT ERREUR ---
        const ConfigError = () => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white p-8 rounded-xl shadow-xl max-w-md text-center">
                    <div className="text-red-500 mb-4 flex justify-center"><Icons.Alert /></div>
                    <h2 className="text-xl font-bold mb-2">Configuration Manquante</h2>
                    <p className="text-slate-600 mb-4">Vous devez éditer le fichier <code>index.html</code> et y coller vos clés Firebase.</p>
                    <div className="text-xs bg-slate-100 p-2 rounded text-left font-mono">const firebaseConfig = &#123; ... &#125;</div>
                </div>
            </div>
        );

        // --- COMPOSANT SELECTEUR DE SECTION ---
        const SectionSelector = ({ selected, onSelect }) => (
            <div className="flex gap-2 mb-6 overflow-x-auto pb-2 custom-scrollbar">
                {Object.entries(BAC_DATA).map(([key, data]) => (
                    <button key={key} onClick={() => onSelect(key)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${selected === key ? `bg-gradient-to-r ${data.color} text-white shadow-md` : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border dark:border-slate-700'}`}>
                        {data.label}
                    </button>
                ))}
            </div>
        );

        // --- COMPOSANT SIMULATEUR ---
        const CalculatorView = ({ section }) => {
            const [grades, setGrades] = useState({});
            const [res, setRes] = useState(null);
            
            // Reset au changement de section
            useEffect(() => { setGrades({}); setRes(null); }, [section]);

            const calculate = () => {
                let pts = 0, coeffs = 0;
                BAC_DATA[section].subjects.forEach(s => {
                    const g = parseFloat(grades[s.id] || 0);
                    if(s.isOption) { if(g > 10) pts += (g - 10); }
                    else { pts += g * s.coeff; coeffs += s.coeff; }
                });
                const moy = pts / coeffs;
                const score = BAC_DATA[section].scoreFormula(moy, grades);
                setRes({ moy: moy.toFixed(2), score: score.toFixed(2) });
            };

            return (
                <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 animate-fadeIn">
                    <h3 className="font-bold text-lg mb-4 text-slate-800 dark:text-white flex items-center gap-2"><Icons.Calculator /> Simulateur {BAC_DATA[section].label}</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
                        {BAC_DATA[section].subjects.map(s => (
                            <div key={s.id} className="flex justify-between items-center bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
                                <label className="text-sm font-medium dark:text-slate-200">{s.name} <span className="text-xs opacity-60">x{s.coeff}</span></label>
                                <input type="number" className="w-16 p-1 border dark:border-slate-600 rounded text-center bg-white dark:bg-slate-800 dark:text-white" placeholder="-" onChange={e => setGrades({...grades, [s.id]: e.target.value})} />
                            </div>
                        ))}
                    </div>
                    <button onClick={calculate} className={`w-full bg-gradient-to-r ${BAC_DATA[section].color} text-white py-3 rounded-xl font-bold shadow-lg hover:opacity-90 transition`}>Calculer Moyenne & Score</button>
                    {res && <div className="mt-6 text-center p-6 bg-slate-900 rounded-2xl text-white shadow-xl animate-fadeIn"><div className="text-4xl font-black mb-1">{res.moy}</div><div className="text-sm opacity-80 uppercase tracking-widest">Moyenne</div><div className="mt-4 pt-4 border-t border-slate-700 text-xl text-indigo-400 font-bold">{res.score} FG</div></div>}
                </div>
            );
        };

        // --- COMPOSANT AGENDA & TÂCHES ---
        const PlanningView = () => {
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('bac_tasks') || '[]'));
            const [newTask, setNewTask] = useState("");
            
            useEffect(() => localStorage.setItem('bac_tasks', JSON.stringify(tasks)), [tasks]);

            const addTask = (e) => {
                e.preventDefault();
                if(!newTask.trim()) return;
                setTasks([...tasks, { id: Date.now(), text: newTask, done: false }]);
                setNewTask("");
            };

            const toggle = (id) => setTasks(tasks.map(t => t.id === id ? {...t, done: !t.done} : t));
            const del = (id) => setTasks(tasks.filter(t => t.id !== id));
            const daysLeft = Math.ceil((new Date("2025-06-04") - new Date()) / (1000 * 60 * 60 * 24));

            return (
                <div className="space-y-6 animate-fadeIn">
                    <div className="bg-slate-900 rounded-2xl p-6 text-white text-center shadow-lg relative overflow-hidden">
                        <div className="text-5xl font-black mb-2">{daysLeft}</div>
                        <div className="text-sm opacity-70 uppercase tracking-widest">Jours avant le Bac</div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6">
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <h4 className="font-bold mb-4 flex gap-2 dark:text-white"><Icons.Calendar /> Dates Clés</h4>
                            <div className="space-y-3">
                                {IMPORTANT_DATES.map((d,i) => (
                                    <div key={i} className="flex justify-between text-sm py-2 border-b dark:border-slate-700 last:border-0 dark:text-slate-300">
                                        <span>{d.event}</span><span className="font-mono bg-slate-100 dark:bg-slate-700 px-2 rounded">{d.date}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <h4 className="font-bold mb-4 flex gap-2 dark:text-white"><Icons.CheckCircle /> Tâches (Auto-Save)</h4>
                            <form onSubmit={addTask} className="flex gap-2 mb-4">
                                <input className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Ajouter une tâche..." value={newTask} onChange={e => setNewTask(e.target.value)} />
                                <button className="bg-green-600 text-white p-2 rounded"><Icons.Plus /></button>
                            </form>
                            <div className="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                                {tasks.map(t => (
                                    <div key={t.id} className="flex items-center justify-between group p-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded">
                                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => toggle(t.id)}>
                                            <div className={`w-4 h-4 border rounded ${t.done ? 'bg-green-500 border-green-500' : 'border-slate-300'}`}></div>
                                            <span className={`text-sm ${t.done ? 'line-through text-slate-400' : 'dark:text-slate-200'}`}>{t.text}</span>
                                        </div>
                                        <button onClick={() => del(t.id)} className="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icons.Trash2 /></button>
                                    </div>
                                ))}
                                {tasks.length === 0 && <p className="text-center text-xs text-slate-400 italic">Aucune tâche.</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPOSANT BIBLIOTHÈQUE ---
        const LibraryView = ({ section }) => {
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [showForm, setShowForm] = useState(false);
            const [file, setFile] = useState(null);
            const [meta, setMeta] = useState({ title: "", author: "" });

            useEffect(() => {
                const initAuth = async () => {
                    setLoading(true);
                    await signInAnonymously(auth);
                    // Requête réelle
                    try {
                        const q = query(collection(db, "resources"), orderBy("createdAt", "desc"));
                        const snap = await getDocs(q);
                        setFiles(snap.docs.map(d => d.data()));
                    } catch (e) { console.error(e); }
                    setLoading(false);
                };
                initAuth();
            }, [uploading]);

            const handleUpload = async (e) => {
                e.preventDefault();
                if(!file) return;
                setUploading(true);
                try {
                    const fRef = ref(storage, `docs/${Date.now()}_${file.name}`);
                    await uploadBytes(fRef, file);
                    const url = await getDownloadURL(fRef);
                    let type = "PDF";
                    if(file.type.includes("image")) type = "Image";
                    if(file.type.includes("video")) type = "Video";
                    
                    await addDoc(collection(db, "resources"), {
                        ...meta, 
                        url, 
                        type, 
                        section, 
                        createdAt: new Date()
                    });
                    alert("Fichier publié !");
                    setFile(null);
                    setShowForm(false);
                } catch(err) { console.error(err); alert("Erreur upload"); }
                setUploading(false);
            };

            return (
                <div className="space-y-6 animate-fadeIn">
                    <div className={`bg-gradient-to-r ${BAC_DATA[section].color} rounded-2xl p-6 text-white shadow-lg flex justify-between items-center`}>
                        <div><h3 className="font-bold text-xl flex gap-2"><Icons.Book /> Bibliothèque</h3><p className="text-sm opacity-80">Cloud Storage</p></div>
                        <button onClick={() => setShowForm(!showForm)} className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition">{showForm ? <Icons.Plus style={{transform:'rotate(45deg)'}}/> : <Icons.Plus />}</button>
                    </div>

                    {showForm && (
                        <form onSubmit={handleUpload} className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border dark:border-slate-700 animate-fadeIn">
                            <h4 className="font-bold mb-4 dark:text-white">Partager un fichier</h4>
                            <div className="grid gap-3">
                                <input className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Titre du cours..." onChange={e => setMeta({...meta, title: e.target.value})} required />
                                <input className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Auteur" onChange={e => setMeta({...meta, author: e.target.value})} required />
                                <input type="file" className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-slate-100 file:text-slate-700 dark:file:bg-slate-700 dark:file:text-white" onChange={e => setFile(e.target.files[0])} required />
                                <button disabled={uploading} className="w-full bg-slate-900 text-white py-2 rounded-lg font-bold flex justify-center items-center gap-2">
                                    {uploading ? <Icons.Loader /> : "Envoyer"}
                                </button>
                            </div>
                        </form>
                    )}

                    <div className="grid md:grid-cols-2 gap-4">
                        {loading ? <div className="col-span-2 text-center p-8"><Icons.Loader /></div> : files.map((f, i) => (
                            <div key={i} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition flex justify-between items-center group">
                                <div className="flex items-center gap-4">
                                    <div className={`p-3 rounded-xl ${f.type === 'PDF' ? 'bg-red-100 text-red-600' : f.type === 'Video' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'}`}>
                                        {f.type === 'PDF' ? <Icons.FileText /> : f.type === 'Video' ? <Icons.Video /> : <Icons.Image />}
                                    </div>
                                    <div className="min-w-0">
                                        <h4 className="font-bold dark:text-white truncate max-w-[150px]">{f.title}</h4>
                                        <p className="text-xs text-slate-500 dark:text-slate-400">{f.author} • {f.type}</p>
                                    </div>
                                </div>
                                <a href={f.url} target="_blank" className="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition flex items-center gap-2">
                                    <Icons.Eye />
                                </a>
                            </div>
                        ))}
                        {!loading && files.length === 0 && <div className="col-span-2 text-center p-8 text-slate-400 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl">Aucun fichier.</div>}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPALE ---
        const App = () => {
            const [tab, setTab] = useState('calc');
            const [section, setSection] = useState('math');
            const [darkMode, setDarkMode] = useState(false);

            if (configError) return <ConfigError />;

            return (
                <div className={darkMode ? 'dark' : ''}>
                    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 transition-colors duration-300 pb-20">
                        <header className="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 px-4 py-3 shadow-sm">
                            <div className="max-w-3xl mx-auto flex justify-between items-center">
                                <div className="flex items-center gap-2 font-bold text-xl text-slate-900 dark:text-white">
                                    <div className="text-red-600"><Icons.GraduationCap /></div> BacHub
                                </div>
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                                    {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                                </button>
                            </div>
                        </header>

                        <main className="max-w-3xl mx-auto p-4 pt-6">
                            <SectionSelector selected={section} onSelect={setSection} />

                            <div className="flex gap-2 mb-8 bg-white dark:bg-slate-800 p-1 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-x-auto">
                                {[
                                    {id:'calc', label:'Simulateur', icon: <Icons.Calculator/>},
                                    {id:'planning', label:'Agenda', icon: <Icons.Calendar/>},
                                    {id:'library', label:'Biblio', icon: <Icons.Book/>}
                                ].map(t => (
                                    <button key={t.id} onClick={() => setTab(t.id)} className={`flex-1 flex items-center justify-center gap-2 py-2.5 px-4 rounded-xl text-sm font-bold transition-all ${tab === t.id ? 'bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-md' : 'text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                                        <span className="scale-75">{t.icon}</span> {t.label}
                                    </button>
                                ))}
                            </div>

                            {tab === 'calc' && <CalculatorView section={section} />}
                            {tab === 'planning' && <PlanningView />}
                            {tab === 'library' && <LibraryView section={section} />}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
